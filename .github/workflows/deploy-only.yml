on:
  workflow_dispatch:
    inputs:
      image_tag_or_digest:
        description: "Tag (e.g. latest or a commit SHA) OR full digest (sha256:...)"
        required: true
        default: "latest"
      region:
        description: "Cloud Run region"
        required: true
        default: "europe-west6"
      service:
        description: "Cloud Run service name"
        required: true
        default: "football-api"
      allow_unauthenticated:
        description: "Allow unauthenticated"
        required: true
        default: "true"
      env_vars:
        description: "KEY=VALUE pairs (comma-separated)"
        required: false
        default: "ENV=prod,MODEL_DIR=/app/model"
      deploy_flags:
        description: "Extra flags (e.g. --max-instances=2 --cpu=1 --memory=512Mi --service-account=...)"
        required: false
        default: "--max-instances=2 --cpu=1 --memory=512Mi --timeout=300"
      project_id:
        description: "Override GCP project (optional)"
        required: false
        default: ""

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          # IMPORTANT: GCP_SA_KEY must be RAW JSON (not base64)
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Install jq (used to parse SA JSON)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Resolve and set active project
        id: project
        shell: bash
        env:
          SA_JSON: ${{ secrets.GCP_SA_KEY }}
          PROJECT_ID_SECRET: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          set -euo pipefail
          PID="${{ inputs.project_id }}"
          if [ -z "$PID" ]; then PID="${PROJECT_ID_SECRET:-}"; fi
          if [ -z "$PID" ]; then PID="$(jq -r '.project_id' <<<"$SA_JSON")"; fi
          echo "Using project: $PID"
          echo "GCP_PROJECT_ID=$PID" >> "$GITHUB_ENV"
          gcloud config set project "$PID" >/dev/null

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Build IMAGE_REF from tag/digest
        id: image
        shell: bash
        env:
          DH_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          set -euo pipefail
          REPO="docker.io/${DH_USER}/football-api"
          IN="${{ inputs.image_tag_or_digest }}"
          case "$IN" in
            sha256:*) IMAGE_REF="${REPO}@${IN}" ;;
            *)        IMAGE_REF="${REPO}:${IN}" ;;
          esac
          echo "IMAGE_REF=$IMAGE_REF" >> "$GITHUB_OUTPUT"
          echo "Using image: $IMAGE_REF"

      - name: Check Cloud Run API (best-effort) and list services
        shell: bash
        run: |
          set -euo pipefail
          if gcloud services list --enabled --project="$GCP_PROJECT_ID" \
               --filter='NAME:run.googleapis.com' --format='value(NAME)' 2>/dev/null \
               | grep -q '^run.googleapis.com$'; then
            echo "Cloud Run API is enabled."
          else
            echo "::warning::Could not verify Cloud Run API (missing viewer perms). If deploy fails, enable it once with:"
            echo "gcloud services enable run.googleapis.com --project=$GCP_PROJECT_ID"
          fi
          gcloud run services list --region='${{ inputs.region }}' --project="$GCP_PROJECT_ID" || true

      - name: Deploy to Cloud Run
        shell: bash
        env:
          IMAGE_REF: ${{ steps.image.outputs.IMAGE_REF }}
        run: |
          set -euo pipefail
          CMD="gcloud run deploy '${{ inputs.service }}' \
            --image='${IMAGE_REF}' \
            --region='${{ inputs.region }}' \
            --platform=managed \
            --project='$GCP_PROJECT_ID'"
          if [ "${{ inputs.allow_unauthenticated }}" = "true" ]; then CMD="$CMD --allow-unauthenticated"; fi
          if [ -n "${{ inputs.env_vars }}" ]; then CMD="$CMD --set-env-vars='${{ inputs.env_vars }}'"; fi
          if [ -n "${{ inputs.deploy_flags }}" ]; then CMD="$CMD ${{ inputs.deploy_flags }}"; fi
          echo "$CMD"
          eval "$CMD"

      - name: Show service URL
        shell: bash
        run: |
          set -euo pipefail
          gcloud run services describe '${{ inputs.service }}' \
            --region='${{ inputs.region }}' \
            --format='value(status.url)' \
            --project="$GCP_PROJECT_ID"
