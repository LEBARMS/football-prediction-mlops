name: deploy-only

on:
  workflow_dispatch:
    inputs:
      image_ref:
        description: "Docker image ref (e.g. anthonyat2002/football-api:latest or anthonyat2002/football-api@sha256:...)"
        required: true
        default: anthonyat2002/football-api:latest
      region:
        required: true
        default: europe-west6

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy football-api \
            --image=docker.io/${{ github.event.inputs.image_ref }} \
            --region=${{ github.event.inputs.region }} --platform=managed \
            --allow-unauthenticated --port=8000 \
            --set-env-vars=ENV=prod --max-instances=2 --cpu=1 --memory=512Mi
      - name: Show service URL
        run: gcloud run services describe football-api --region=${{ github.event.inputs.region }} --format='value(status.url)'
