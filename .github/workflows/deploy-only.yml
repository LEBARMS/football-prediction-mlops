name: deploy-only-to-cloud-run

on:
  workflow_dispatch:
    inputs:
      docker_repo:
        description: "Container repo (e.g., docker.io/<user>/football-api)"
        required: true
        default: "docker.io/your-dockerhub-username/football-api"
      image_digest:
        description: "Image digest (with or without 'sha256:')"
        required: true
      region:
        description: "Cloud Run region"
        required: true
        default: "europe-west6"
      service:
        description: "Cloud Run service name"
        required: true
        default: "football-api"
      allow_unauthenticated:
        description: "Allow unauthenticated invocations"
        required: true
        default: "true"
      port:
        description: "Container port"
        required: true
        default: "8000"
      env_vars:
        description: "Comma-separated KEY=VALUE pairs for --set-env-vars (leave empty for none)"
        required: false
        default: "ENV=prod"
      deploy_flags:
        description: "Extra gcloud flags (e.g. --max-instances=2 --cpu=1 --memory=512Mi)"
        required: false
        default: "--max-instances=2 --cpu=1 --memory=512Mi"

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Print selected ref and inputs
        run: |
          echo "REF=${GITHUB_REF}"
          echo "SHA=${GITHUB_SHA}"
          echo "docker_repo='${{ inputs.docker_repo }}'"
          echo "image_digest='${{ inputs.image_digest }}'"

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Build IMAGE_REF from digest
        id: image
        shell: bash
        run: |
          set -euo pipefail
          DIG="${{ inputs.image_digest }}"
          [[ "$DIG" == sha256:* ]] || DIG="sha256:${DIG}"
          IMAGE_REF="${{ inputs.docker_repo }}@${DIG}"
          echo "IMAGE_REF=$IMAGE_REF" >> "$GITHUB_OUTPUT"
          echo "Using image: $IMAGE_REF"

      - name: Verify account, project, and region access
        run: |
          set -euo pipefail
          gcloud --version
          gcloud auth list
          gcloud config list
          gcloud projects describe ${{ secrets.GCP_PROJECT_ID }} --format='value(projectNumber)'
          gcloud services enable run.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }}
          gcloud run services list --region='${{ inputs.region }}' --project='${{ secrets.GCP_PROJECT_ID }}' || true

      - name: Deploy to Cloud Run (by digest)
        shell: bash
        run: |
          set -euo pipefail
          ARGS=(
            "--image=${{ steps.image.outputs.IMAGE_REF }}"
            "--region=${{ inputs.region }}"
            "--platform=managed"
            "--port=${{ inputs.port }}"
            "--project=${{ secrets.GCP_PROJECT_ID }}"
          )
          # Allow unauthenticated if requested
          if [[ "${{ inputs.allow_unauthenticated }}" == "true" ]]; then
            ARGS+=("--allow-unauthenticated")
          fi
          # Env vars
          if [[ -n "${{ inputs.env_vars }}" ]]; then
            ARGS+=("--set-env-vars=${{ inputs.env_vars }}")
          fi
          # Extra flags (size, etc.)
          if [[ -n "${{ inputs.deploy_flags }}" ]]; then
            # shellsplit: expand flags into array
            read -r -a EXTRA <<< "${{ inputs.deploy_flags }}"
            ARGS+=("${EXTRA[@]}")
          fi
          echo "gcloud run deploy '${{ inputs.service }}' ${ARGS[*]}"
          gcloud run deploy "${{ inputs.service }}" "${ARGS[@]}"

      - name: Show service URL
        run: |
          gcloud run services describe '${{ inputs.service }}' \
            --region='${{ inputs.region }}' \
            --format='value(status.url)' \
            --project='${{ secrets.GCP_PROJECT_ID }}'
